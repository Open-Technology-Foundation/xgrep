#!/bin/bash
# Bash completion for xgrep, bashgrep, phpgrep, pygrep
# Source this file or copy to /etc/bash_completion.d/

_xgrep_completion() {
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    # Main options for all xgrep tools
    opts="-d --maxdepth -X --exclude-dir -D --debug -V --version --help -- --rg"
    
    # Ripgrep options (subset of most commonly used)
    rg_opts="-i --ignore-case -v --invert-match -w --word-regexp -x --line-regexp
             -c --count -l --files-with-matches -L --files-without-match
             -n --line-number -N --no-line-number -H --with-filename -h --no-filename
             -o --only-matching -r --replace -A --after-context -B --before-context
             -C --context -m --max-count --max-depth -s --case-sensitive -S --smart-case
             -u --unrestricted -g --glob -t --type -T --type-not --color --no-config
             -j --threads -M --max-columns --no-heading --heading --vimgrep -0 --null
             -q --quiet --stats -e --regexp -f --file --fixed-strings -F --no-fixed-strings
             -P --pcre2 --engine --no-unicode -z --search-zip"

    case ${prev} in
        -d|--maxdepth|--max-depth)
            # Complete with numbers for depth
            COMPREPLY=( $(compgen -W "1 2 3 4 5 10 20" -- ${cur}) )
            return 0
            ;;
        -X|--exclude-dir)
            # Complete with common directory names to exclude
            COMPREPLY=( $(compgen -W ".git .venv node_modules build dist target tmp temp .tmp .temp .Trash-0 .cache __pycache__ .pytest_cache .tox .mypy_cache" -- ${cur}) )
            return 0
            ;;
        -A|--after-context|-B|--before-context|-C|--context|-m|--max-count)
            # Complete with numbers for context/count
            COMPREPLY=( $(compgen -W "1 2 3 5 10" -- ${cur}) )
            return 0
            ;;
        -t|--type)
            # File types (for ripgrep)
            COMPREPLY=( $(compgen -W "sh php py python bash shell" -- ${cur}) )
            return 0
            ;;
        -T|--type-not)
            # File types to exclude
            COMPREPLY=( $(compgen -W "sh php py python bash shell" -- ${cur}) )
            return 0
            ;;
        -g|--glob)
            # Glob patterns
            COMPREPLY=( $(compgen -W "*.sh *.php *.py *.bash *.phtml *.pyw" -- ${cur}) )
            return 0
            ;;
        --color)
            COMPREPLY=( $(compgen -W "never always auto" -- ${cur}) )
            return 0
            ;;
        --engine)
            COMPREPLY=( $(compgen -W "default pcre2 auto" -- ${cur}) )
            return 0
            ;;
        -r|--replace|-e|--regexp|-f|--file)
            # These options expect user input, no completion
            return 0
            ;;
    esac

    # Handle -- and --rg options (pass everything to ripgrep)
    local i
    for (( i=1; i < COMP_CWORD; i++ )); do
        if [[ "${COMP_WORDS[i]}" == "--" || "${COMP_WORDS[i]}" == "--rg" ]]; then
            # After -- or --rg, complete with ripgrep options
            if [[ ${cur} == -* ]]; then
                COMPREPLY=( $(compgen -W "${rg_opts}" -- ${cur}) )
            else
                # Complete with directories for pattern/directory arguments
                COMPREPLY=( $(compgen -d -- ${cur}) )
            fi
            return 0
        fi
    done

    # Default completion
    if [[ ${cur} == -* ]]; then
        # Complete with options
        COMPREPLY=( $(compgen -W "${opts} ${rg_opts}" -- ${cur}) )
    else
        # For non-option arguments, complete with directories
        # First non-option is pattern (no completion), second is directory
        local non_option_count=0
        for (( i=1; i < COMP_CWORD; i++ )); do
            if [[ "${COMP_WORDS[i]}" != -* && "${COMP_WORDS[i-1]}" != "-d" && "${COMP_WORDS[i-1]}" != "--maxdepth" && "${COMP_WORDS[i-1]}" != "-X" && "${COMP_WORDS[i-1]}" != "--exclude-dir" && "${COMP_WORDS[i-1]}" != "-A" && "${COMP_WORDS[i-1]}" != "--after-context" && "${COMP_WORDS[i-1]}" != "-B" && "${COMP_WORDS[i-1]}" != "--before-context" && "${COMP_WORDS[i-1]}" != "-C" && "${COMP_WORDS[i-1]}" != "--context" && "${COMP_WORDS[i-1]}" != "-m" && "${COMP_WORDS[i-1]}" != "--max-count" && "${COMP_WORDS[i-1]}" != "-t" && "${COMP_WORDS[i-1]}" != "--type" && "${COMP_WORDS[i-1]}" != "-T" && "${COMP_WORDS[i-1]}" != "--type-not" && "${COMP_WORDS[i-1]}" != "-g" && "${COMP_WORDS[i-1]}" != "--glob" && "${COMP_WORDS[i-1]}" != "--color" && "${COMP_WORDS[i-1]}" != "--engine" && "${COMP_WORDS[i-1]}" != "-r" && "${COMP_WORDS[i-1]}" != "--replace" && "${COMP_WORDS[i-1]}" != "-e" && "${COMP_WORDS[i-1]}" != "--regexp" && "${COMP_WORDS[i-1]}" != "-f" && "${COMP_WORDS[i-1]}" != "--file" ]]; then
                ((non_option_count++))
            fi
        done
        
        if [[ $non_option_count -eq 0 ]]; then
            # First argument is pattern - no completion
            COMPREPLY=()
        else
            # Second argument is directory - complete with directories
            COMPREPLY=( $(compgen -d -- ${cur}) )
        fi
    fi
}

# Register completion for all four commands
complete -F _xgrep_completion xgrep
complete -F _xgrep_completion bashgrep
complete -F _xgrep_completion phpgrep
complete -F _xgrep_completion pygrep